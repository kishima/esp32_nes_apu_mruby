# CLAUDE_ja.md

このファイルは、このリポジトリでコード作業をする際の Claude Code (claude.ai/code) 向けのガイダンスを提供します。

## プロジェクト概要

これは Peter Barrett の esp_8_bit から派生した ESP32 ベースの NES エミュレータプロジェクトで、Arduino IDE から ESP-IDF ビルドシステムに変換されています。プロジェクト名は APU に焦点を当てているように見えますが、現在は映像・音声・入力システムを含む**完全な NES エミュレータ**です。APU 重点ビルド用に Bluetooth HID サポートが部分的に削除/スタブ化されています。

**オリジナルとの主な違い**: より良いハードウェア制御とメモリ管理のため、Arduino フレームワークから ESP-IDF v5.4+ コンポーネントアーキテクチャに変換。

## ビルドシステム

**主要ビルド方法:**
```bash
./.devcontainer/run_devcontainer.sh idf.py build
./.devcontainer/run_devcontainer.sh idf.py flash
./.devcontainer/run_devcontainer.sh idf.py monitor
```

**Docker ビルド方法:**
```bash
# まずコンテナをビルド
cd .devcontainer
./build.sh

# その後、開発にコンテナを使用
```

**設定:**
- ESP-IDF v5.4+ が必要（Arduino ではない）
- ROM ストレージ用の 256KB SPIFFS を含むカスタムパーティションテーブル
- APU ビルドでは Bluetooth 機能がスタブ化/無効化
- デュアルコアアーキテクチャを使用: Core 0 でエミュレーション、Core 1 でシステムタスク

## アーキテクチャ概要

### コアコンポーネント構造
```
main.cpp (ESP32 アプリケーションエントリ)
├── ファイルシステムマウント (SPIFFS)
├── エミュレータ初期化 (Nofrendo/Atari800/SMSPlus)
├── HID スタブ初期化 (Bluetooth 削除済み)
└── 映像・音声出力付きデュアルコア実行

components/apu_emu/
├── src/emu.h - 汎用エミュレータインターフェース
├── src/emu.cpp - ベースエミュレータフレームワーク & ファイルシステム
├── src/emu_nofrendo.cpp - NES 専用実装
├── src/gui.cpp - ユーザーインターフェースとファイルブラウザー
├── src/hid.cpp - 入力スタブ（Bluetooth HID 削除済み）
├── src/video_out.h - ESP32 映像・音声ハードウェア抽象化
└── src/nofrendo/ - 完全な NES エミュレーションコア
    ├── nes_apu.c/h - APU（5チャンネル音声）エミュレーション
    ├── nes_ppu.c/h - PPU（グラフィック）エミュレーション
    ├── nes6502.c/h - CPU（6502）エミュレーション
    ├── nes.c/h - メイン NES システムコントローラ
    └── [80個以上のメモリマッパー実装]
```

### ソフトウェアアーキテクチャ層

エミュレータは 3 つの主要な C++ コンポーネントによるクリーンな層状アーキテクチャに従っています：

```
┌─────────────────────────────────────────┐
│        GUI 層 (gui.cpp)                 │
│  ファイルブラウザ │ 入力処理 │ オーバーレイ │
│  - ROM ファイル選択とブラウジング         │
│  - USB HID キーボード入力処理            │
│  - 画面表示と UI レンダリング            │
│  - メニューナビゲーションとユーザー操作   │
└─────────────────┬───────────────────────┘
                  │
┌─────────────────┴───────────────────────┐
│   エミュレーション層 (emu_nofrendo.cpp) │
│   NES コア │ 音声/映像 │ 入力マップ      │
│  - Nofrendo を使用した NES 専用エミュ    │
│  - NTSC/PAL パレットとタイミング制御     │
│  - NES コントローラー入力マッピング       │
│  - APU 音声処理とバッファリング          │
└─────────────────┬───────────────────────┘
                  │
┌─────────────────┴───────────────────────┐
│        ベース層 (emu.cpp)               │
│  ファイルシステム │ メモリ管理 │ 枠組み   │
│  - CrapFS: カスタムフラッシュファイル系  │
│  - 大容量ファイル用 ROM メモリマップング │
│  - 抽象 Emu ベースクラスフレームワーク   │
│  - クロスプラットフォームファイル読込    │
└─────────────────────────────────────────┘
```

**層間相互作用:**
- **GUI → エミュレーション**: ROM 読み込みに `emu->insert()`、フレーム更新に `emu->update()` 呼び出し
- **エミュレーション → ベース**: ファイル読み込み、メモリマッピング、音声映像基盤を使用
- **GUI ← エミュレーション**: `video_buffer()` で映像バッファ、`audio_buffer()` で音声を取得

### NES APU（音声処理ユニット）アーキテクチャ
**ハードウェア精度の 5チャンネル音声合成器:**
- **パルスチャンネル 1 & 2**（0x4000-0x4007）: デューティサイクル、エンベロープ、スウィープ付き矩形波
- **三角波チャンネル**（0x4008-0x400B）: ベース用線形三角波
- **ノイズチャンネル**（0x400C-0x400F）: LFSR ベースノイズ生成
- **DMC チャンネル**（0x4010-0x4013）: サンプル用デルタ変調

**音声処理パイプライン:**
```
NES CPU レジスタ書き込み → APU チャンネル更新 → サンプル生成（15.7kHz）→
audio_write_16() → PWM 出力（GPIO18）→ RC フィルタ → 音声出力
```

### ESP32 ハードウェア統合
- **映像出力**: I2S DMA → DAC（GPIO25）→ コンポジット映像
- **音声出力**: LEDC PWM（GPIO18）→ RC フィルタ必須
- **入力**: Bluetooth HID（スタブ化）または IR（GPIO0）
- **ストレージ**: ROM ファイル用 SPIFFS パーティション

### メモリ管理と ROM 読み込み
**CrapFS システム**: 大容量 ROM キャッシュ用 ESP32 フラッシュパーティション上のカスタムファイルシステムオーバーレイ
**メモリマッピング**: RAM コピー不要の効率的な ROM アクセス用直接 SPI フラッシュマッピング
**PSRAM 使用**: 利用可能な場合、映像フレームバッファとエミュレーション状態を PSRAM に保存

### コア C++ ファイルの詳細責任

#### **emu.cpp** - 基盤・ファイルシステム層
**主要役割**: ベースエミュレータフレームワークと ROM ファイル管理基盤の提供

**主要コンポーネント:**
- **CrapFS クラス**: ESP32 パーティションに ROM ファイルを保存するカスタムフラッシュファイルシステム
  - `mmap()`: ゼロコピーアクセス用フラッシュパーティションからファイルをメモリマップ
  - `create()`: カスタムファイルシステムに新ファイル作成
  - `find()`: ファイルシステム内のファイルを効率的に検索
- **Emu ベースクラス**: すべてのエミュレータ実装の抽象基盤
  - 共通音声/映像パラメータ（周波数、フォーマット、寸法）定義
  - `frame_sample_count()`: 映像フレーム当たりの正確な音声サンプル計算
  - `load()` と `head()`: 統一ファイル読み込みユーティリティ
- **メモリ管理**: `map_file()`, `unmap_file()` が RAM より大きい ROM のフラッシュメモリマッピングを処理
- **クロスプラットフォームユーティリティ**: 入力マッピングヘルパーとファイルフォーマット検出

#### **gui.cpp** - ユーザーインターフェース・入力処理層
**主要役割**: ファイルブラウジングと入力処理を含む完全なユーザーインターフェースシステム

**主要コンポーネント:**
- **Overlay クラス**: 高度な画面表示システム
  - `draw_char()`: カラーブリッティング付きハードウェア加速文字レンダリング
  - `frame()`: 透明度とアルファブレンディング効果付き UI フレームレンダリング
  - `set_colors()`: 異なるシステム用の動的カラーパレット管理
- **GUI クラス**: フル機能ファイルブラウザとメニューシステム
  - `read_directory()`: フィルタリング付きで互換性のある ROM ファイルをファイルシステムスキャン
  - `draw_files()`, `draw_help()`, `draw_info()`: 複数 UI パネルレンダリング
  - `key()`: 完全なキーボードナビゲーションと入力処理
  - `update_video()`, `update_audio()`: 60FPS でのリアルタイム UI 更新
- **HID 統合**:
  - `gui_hid()`: USB HID キーボードイベント解析と変換
  - `keyboard()`: HID スキャンコードを GUI ナビゲーションアクションにマップ
- **音声フィードバック**: クリック音と UI 音声生成

#### **emu_nofrendo.cpp** - NES エミュレーション実装層
**主要役割**: Nofrendo エンジンを使用した完全な NES システムエミュレーション

**主要コンポーネント:**
- **EmuNofrendo クラス**: Emu ベースフレームワークを継承したフル NES エミュレータ
  - `insert()`: NES ROM 検証、読み込み、Nofrendo エンジン初期化
  - `update()`: NES エミュレーション（CPU、PPU、APU）の完全フレーム実行
  - `key()` と `hid()`: NES 専用コントローラー入力マッピングと処理
  - `audio_buffer()`: リアルタイム NES APU 音声処理とバッファリング
- **カラーシステム**:
  - `make_nes_palette()`: 正確な NTSC/PAL カラールックアップテーブル生成
  - `make_yuv_palette()`: コンポジット映像カラー変換テーブル作成
  - 最適化されたパフォーマンス用事前計算済み 3相・4相カラーパレット
- **入力マッピング**: 包括的コントローラーサポート
  - `_common_nes[]`, `_classic_nes[]`, `_generic_nes[]`: 複数コントローラーレイアウト
  - 十字キー、A/B ボタン、Start/Select、特殊機能マッピング
- **Nofrendo 統合**: ESP32 ハードウェアと NES コア間のシームレスブリッジ
  - メモリ管理、タイミング同期、ハードウェア抽象化を処理
  - すべての NES サブシステム処理: 6502 CPU、PPU グラフィック、5チャンネル APU 音声

## 現在の状態と既知の問題

### 動作中のコンポーネント
- ✅ 完全な NES/Atari/SMS エミュレーションコア
- ✅ ESP32 ハードウェア抽象化（I2S、DAC、PWM）
- ✅ SPIFFS ファイルシステム統合
- ✅ 音声処理パイプライン（APU → PWM 出力）
- ✅ ビルドシステム（ESP-IDF コンポーネント）

### 対処が必要な問題
- ❌ **GUI クラッシュ**: 映像バッファ（`_lines`）での NULL ポインタアクセス
- ❌ **入力システム**: HID スタブの適切な統合または削除が必要
- ❌ **mruby 統合**: プロジェクト名にもかかわらず欠落
- ❌ **映像出力**: コンポジット出力用の適切な GPIO/DAC 設定が必要

### 開発ノート
- **ESP_PLATFORM**: ESP-IDF で自動定義、ESP32 専用コードパス有効化
- **Bluetooth HID**: APU 重点ビルド用に完全削除/スタブ化
- **マルチコア**: エミュレーションは Core 0、システムタスクは Core 1 で実行
- **音声レイテンシ**: 1024サンプル循環バッファで約1ms バッファリング

## 設定ファイル

- `sdkconfig.defaults` - ESP32 プロジェクト設定（Bluetooth 無効化）
- `partitions.csv` - フラッシュレイアウト: 256KB SPIFFS、1.7MB アプリパーティション
- `components/apu_emu/CMakeLists.txt` - コンポーネントビルド設定
- 映像: GPIO25（コンポジット）、音声: GPIO18（PWM+RC フィルタ）、IR: GPIO0

## 主要技術詳細

**映像システム**: I2S DMA とハードウェア DAC を使用して NTSC（1行当たり228カラークロック）または PAL（1行当たり284カラークロック）コンポジット映像を生成。異なるエミュレートシステム用の複数ピクセル対カラークロック比をサポート。

**APU タイミング**: NES APU は CPU クロック/12（内部約179kHz）で動作、NTSC 約15.7kHz、PAL 約15.6kHz でサンプル出力。各音声フレームは 60Hz/50Hz 映像同期用の正確なサンプル数を生成。

**ROM ストレージ**: 大容量 ROM ファイル用カスタム CrapFS 使用、SPIFFS から SPI フラッシュパーティションへの自動コピーでゼロコピーアクセス用メモリマッピング。

**ビルド要件**: ESP-IDF v5.4+、Docker コンテナ提供、フルハードウェア互換性には ESP32（S2/S3/C3 ではない）が必要。

## 未実装機能

- **mruby 統合**: プロジェクト名にもかかわらず Ruby スクリプティングなし
- **APU 重点機能**: 音声専用でなく、フルエミュレータ存在
- **モダン入力**: 現在の HID システムは複雑、よりシンプルな GPIO ボタンが有益
- **音声視覚化**: 開発・デバッグ用 APU 解析ツール